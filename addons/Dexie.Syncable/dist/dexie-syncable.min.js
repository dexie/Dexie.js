(function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("dexie"),require("dexie-observable")):"function"==typeof define&&define.amd?define(["dexie","dexie-observable"],n):((e="undefined"!=typeof globalThis?globalThis:e||self).Dexie=e.Dexie||{},e.Dexie.Syncable=n(e.Dexie))})(this,function(e){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var R=n(e),s=R.default.Promise;function d(e){return n.prototype.save=function(){return R.default.vip(function(){return e.save()})},n;function n(e,n){this.nodeID=e,n&&R.default.extend(this,n)}}var y=1,h=2,u=3;function O(c){return function(e){var i={};e.forEach(function(e){var n;i.hasOwnProperty(e.table)||(i[e.table]=((n={})[y]=[],n[u]=[],n[h]=[],n)),i[e.table][e.type].push(e)});var n=Object.keys(i),t=n.map(function(e){return c.table(e)});return c.transaction("rw",t,function(){n.forEach(function(e){var n=c.table(e),t=!n.schema.primKey.keyPath,r=i[e][y],o=i[e][u],a=i[e][h];0<r.length&&n.bulkPut(r.map(function(e){return e.obj}),t?r.map(function(e){return e.key}):void 0),0<a.length&&function(n,t){var e=t.map(function(e){return e.key}),r={};n.where(":id").anyOf(e).raw().each(function(e,n){r[n.primaryKey+""]=e}).then(function(){var e=t.filter(function(e){return r.hasOwnProperty(e.key+"")}).map(function(n){var t=r[n.key+""];return Object.keys(n.mods).forEach(function(e){R.default.setByKeyPath(t,e,n.mods[e])}),t});return n.bulkPut(e)})}(n,a),0<o.length&&n.bulkDelete(o.map(function(e){return e.key}))})})}}function v(e){if(0===e.remoteBaseRevisions.length)return{maxClientRevision:1/0,remoteBaseRevision:null};for(var n=e.remoteBaseRevisions.length-1;0<=n;--n)if(e.myRevision>=e.remoteBaseRevisions[n].local)return{maxClientRevision:n===e.remoteBaseRevisions.length-1?1/0:e.remoteBaseRevisions[n+1].local,remoteBaseRevision:e.remoteBaseRevisions[n].remote};return{maxClientRevision:e.remoteBaseRevisions[0].local,remoteBaseRevision:null}}function b(e,n){switch(e.type){case y:switch(n.type){case y:return n;case h:return function(e,n){var t=R.default.deepClone(e);return Object.keys(n.mods).forEach(function(e){R.default.setByKeyPath(t.obj,e,n.mods[e])}),t}(e,n);case u:return n}break;case h:switch(n.type){case y:return n;case h:return function(e,r){var o=R.default.deepClone(e);return Object.keys(r.mods).forEach(function(n){var t=!1;Object.keys(e.mods).filter(function(e){return 0===n.indexOf(e+".")}).forEach(function(e){R.default.setByKeyPath(o.mods[e],n.substr(e.length+1),r.mods[n]),t=!0}),t||(o.mods[n]=r.mods[n]),Object.keys(e.mods).filter(function(e){return 0===e.indexOf(n+".")}).forEach(function(e){delete o.mods[e]})}),o}(e,n);case u:return n}break;case u:switch(n.type){case y:return n;case h:case u:return e}}}function o(s,u,e){var l=e;return function(e,r){var n=function(u,l,f){return function(e,n,t,r){var a={},i=0,o=!1,c=l.id,s=e;return u.transaction("r",u._changes,function(){return u._changes.where("rev").between(e,t,!1,!0).until(function(){if(i===n)return o=!0}).each(function(e){if(s=e.rev,e.source!==c){var n={type:e.type,table:e.table,key:e.key};e.type===y?n.obj=e.obj:e.type===h&&(n.mods=e.mods);var t=e.table+":"+e.key,r=a[t];if(r){var o=b(r,n);a[t]=o}else a[t]=n,++i}})}).then(function(){var e=Object.keys(a).map(function(e){return a[e]});return f.hasMoreToGive=o,r(e,o,{myRevision:s})})}}(s,e,u),t=function(i,c,s,u,l,f){return function e(t,o,n){var a=!1;return n.until(function(){if(o.length===s)return a=!0}).each(function(e,n){o.push({type:y,table:t.currentTable,key:n.key,obj:n.value}),t.currentKey=n.key}).then(function(){if(a)return l.hasMoreToGive=!0,f(o,null,!0,{dbUploadState:t});if(0!==t.tablesToUpload.length)return t.currentTable=t.tablesToUpload.shift(),e(t,o,i.table(t.currentTable).orderBy(":id"));var r=v(c);return u(t.localBaseRevision,s-o.length,r.maxClientRevision,function(e,n,t){return o=o.concat(e),t.dbUploadState=null,f(o,r.remoteBaseRevision,n,t)})})}}(s,e,l,n,u,r);if(0<=e.myRevision){var o=v(e);return n(e.myRevision,l,o.maxClientRevision,function(e,n,t){return r(e,o.remoteBaseRevision,n,t)})}if(null===e.dbUploadState){var a=s.tables.filter(function(e){return e.schema.observable}).map(function(e){return e.name});if(0===a.length)return R.default.Promise.resolve(r([],null,!1,{}));var i={tablesToUpload:a,currentTable:a.shift(),currentKey:null};return s._changes.orderBy("rev").last(function(e){i.localBaseRevision=e&&e.rev||0;var n=s.table(i.currentTable).orderBy(":id");return t(i,[],n)})}if(e.dbUploadState.currentKey){var c=s.table(e.dbUploadState.currentTable).where(":id").above(e.dbUploadState.currentKey);return t(R.default.deepClone(e.dbUploadState),[],c)}c=s.table(i.currentTable).orderBy(":id");return t(R.default.deepClone(e.dbUploadState),[],c)}}var w={ERROR:-1,OFFLINE:0,CONNECTING:1,ONLINE:2,SYNCING:3,ERROR_WILL_RETRY:4},E=R.default.Promise;function p(b,p,a,m,g){var i=function(a){return function e(n,t,r){function o(){return n.ongoingOperation?n.ongoingOperation=n.ongoingOperation.then(function(){return e(n,t,r)}):n.ongoingOperation=R.default.ignoreTransaction(function(){return R.default.vip(function(){return t()})}).finally(function(){delete n.ongoingOperation}),n.ongoingOperation}return r?a._localSyncNode&&r===a._localSyncNode.id?o():R.default.Promise.reject(new R.default.DatabaseClosedError):a.isOpen()?o():R.default.Promise.reject(new R.default.DatabaseClosedError)}}(b),t={hasMoreToGive:!0};function N(){return b._localSyncNode&&b._localSyncNode.id===a}return function(s,u){var l,c=o(b,t,p.partialsThreshold),f=u.url;function d(e){s.status!==e&&(s.status=e,s.save().then(function(){b.syncable.on.statusChanged.fire(e,f),b.observable.broadcastMessage("syncStatusChanged",{newStatus:e,url:f},!1)}).catch("DatabaseClosedError",function(){}))}return u.on("disconnect",function(e){isNaN(e)||d(e)}),d(w.CONNECTING),y();function y(){return i(y,function(){return n(s,e)},a)}function e(e,o,a,n){var t=new E(function(t,r){g.p=function(e){r(e)},R.default.asap(function(){try{p.sync(s.syncContext,f,m,o,s.appliedRemoteRevision,e,a,v,i,function(e){t(e)},n)}catch(e){n(e,1/0)}function n(e,n){r(e),N()&&(!isNaN(n)&&n<1/0?(setTimeout(function(){N()&&(d(w.SYNCING),y().catch("DatabaseClosedError",h))},n),d(w.ERROR_WILL_RETRY),l&&l.disconnect&&l.disconnect(),l=null):h(e))}})});return t.then(function(){}).finally(function(){g.p=null});function i(){return Object.keys(n).forEach(function(e){R.default.setByKeyPath(s,e,n[e])}),t.then(r),s.save()}}function h(e){u.disconnect(w.ERROR,e)}function n(a,i){return c(a,function e(n,t,r,o){return 0===n.length&&"myRevision"in o&&o.myRevision!==a.myRevision?(Object.keys(o).forEach(function(e){R.default.setByKeyPath(a,e,o[e])}),a.save().catch("DatabaseClosedError",function(){}),c(a,e)):i(n,t,r,o)})}function v(e,n,t){var r=function(t,r){return function(e,n){return t.transaction("rw!",t._uncommittedChanges,function(){return t._uncommittedChanges.bulkAdd(e.map(function(e){var n={node:r.id,type:e.type,table:e.table,key:e.key};return e.obj&&(n.obj=e.obj),e.mods&&(n.mods=e.mods),n}))}).then(function(){return r.appliedRemoteRevision=n,r.save()})}}(b,s),o=function(t,a){var i=O(t);return function(n,o){var e=t.tables.filter(function(e){return"_changes"===e.name||"_uncommittedChanges"===e.name||e.schema.observable});return t.transaction("rw!",e,function(){var e=R.default.currentTransaction,r=0;return t._changes.orderBy("rev").last(function(e){r=e&&e.rev||0}).then(function(){return e.source=a.id,t._uncommittedChanges.where("node").equals(a.id).toArray()}).then(function(e){return i(e)}).then(function(){return t._uncommittedChanges.where("node").equals(a.id).delete()}).then(function(){return i(n)}).then(function(){return t._changes.orderBy("rev").last()}).then(function(e){var n=e&&e.rev||0;if(a.appliedRemoteRevision=o,a.remoteBaseRevisions.push({remote:o,local:n}),a.myRevision===r&&(a.myRevision=n),1<a.remoteBaseRevisions.length)for(var t=a.remoteBaseRevisions.length-1;0<t;--t)if(a.myRevision>=a.remoteBaseRevisions[t].local){a.remoteBaseRevisions.splice(0,t);break}a.save().catch(function(e){console.warn("Dexie.Syncable: Unable to save SyncNode after applying remote changes: "+(e.stack||e))})})})}}(b,s);return i(v,function(){return N()?(t?r(e,n):o(e,n)).catch(function(e){return h(e),E.reject(e)}):E.reject(new R.default.DatabaseClosedError)},a)}function r(e){N()?(l=e,u.on("disconnect",function(){if(l){if(l.react)try{l.disconnect()}catch(e){}l=null}}),e.react?function(o){var a,i;function e(){l&&(d(w.SYNCING),i?a=!0:c())}function c(){l&&(i=!(a=!1),n(s,function(e,n,t,r){l&&(0<e.length?o.react(e,n,t,function(){Object.keys(r).forEach(function(e){R.default.setByKeyPath(s,e,r[e])}),s.save().catch("DatabaseClosedError",function(){}),c()}):(i=!1,a?c():d(w.ONLINE)))}).catch(function(e){console.error("Got ".concat(e.message," caught by reactToChanges")),h(e)}))}b.on("changes",e),u.on("disconnect",function(){b.on.changes.unsubscribe(e)}),c()}(e):function(){function o(){n(s,function(e,n,t,r){p.sync(s.syncContext,f,m,n,s.appliedRemoteRevision,e,t,v,function(){Object.keys(r).forEach(function(e){R.default.setByKeyPath(s,e,r[e])}),s.save().catch("DatabaseClosedError",function(){})},function(e){if(!l)return;l=e,t?o():!isNaN(e.again)&&e.again<1/0?(d(w.ONLINE),setTimeout(function(){l&&(d(w.SYNCING),o())},e.again)):u.disconnect(w.OFFLINE)},function(e,n){!isNaN(n)&&n<1/0?l&&(setTimeout(function(){l&&(d(w.SYNCING),o())},n),d(w.ERROR_WILL_RETRY)):h(e)})}).catch(h)}t.hasMoreToGive?o():l&&!isNaN(l.again)&&l.again<1/0?(d(w.ONLINE),setTimeout(function(){l&&(d(w.SYNCING),o())},l.again)):u.disconnect(w.OFFLINE)}()):e.disconnect&&e.disconnect()}}}function a(l,f){return function(t,i,c,s,u){var e=f.filter(function(e){return e.url===c});if(0<e.length){var n=e[0],r={};return R.default.getObjectDiff(n.syncOptions,s,r),0!==Object.keys(r).length?l.syncable.disconnect(c).then(function(){return o()}):e[0].connectPromise}function o(){var r={p:null},n=p(l,t,u,s,r),e=function(o,a,i){return function(r){return o.transaction("rw",o._syncNodes,o._changes,function(){if(!i)throw new Error("Url cannot be empty");return o._syncNodes.where("url").equalsIgnoreCase(i).first(function(n){if(n){var e=d(n);n.syncContext=new e(n.id,n.syncContext),n.syncProtocol=a,n.syncOptions=r,o._syncNodes.put(n)}else{(n=new o.observable.SyncNode).myRevision=-1,n.appliedRemoteRevision=null,n.remoteBaseRevisions=[],n.type="remote",n.syncProtocol=a,n.url=i,n.syncOptions=r,n.lastHeartBeat=Date.now(),n.dbUploadState=null;var t=d(n);R.default.Promise.resolve(function(){if(!1===r.initialUpload)return o._changes.toCollection().lastKey(function(e){n.myRevision=e})}()).then(function(){o._syncNodes.add(n).then(function(e){n.syncContext=new t(e),o._syncNodes.put(n)})})}return n})})}}(l,i,c)(s).then(function(e){return n(e,a)}),o=!1,a={url:c,status:w.OFFLINE,connectPromise:e,syncOptions:s,on:R.default.Events(null,"disconnect"),disconnect:function(e,n){var t=f.indexOf(a);0<=t&&f.splice(t,1),n&&r.p&&r.p(n),o||a.on.disconnect.fire(e,n),o=!0}};return f.push(a),e}return o()}}var i=R.default.override,c=R.default.Promise,l=R.default.Observable;function f(t){if(!/^(3|4)\./.test(R.default.version))throw new Error("Missing dexie version 3.x or 4.x");if(!t.observable||"4.0.0-beta.13"!==t.observable.version&&!/^(3|4)\./.test(t.observable.version))throw new Error("Missing dexie-observable version 3.x or 4.x");if(t.syncable){if("4.0.0-beta.13"!==t.syncable.version)throw new Error("Mixed versions of dexie-syncable")}else{var r=[],e=a(t,r),o=function(c,n){return function(e,o,a,i){if(c.isOpen()){if(!c._localSyncNode)throw new Error("Precondition failed: local sync node is missing. Make sure Dexie.Observable is active!");return c._localSyncNode.isMaster?n(e,o,a,i,c._localSyncNode.id):c.table("_syncNodes").where("isMaster").above(0).first(function(e){return c.observable.sendMessage("connect",{protocolName:o,url:a,options:i},e.id,{wantReply:!0})})}return c.hasBeenClosed()?s.reject(new R.default.DatabaseClosedError):c.hasFailed()?s.reject(new R.default.InvalidStateError("Dexie.Syncable: Cannot connect. Database has failed to open")):new s(function(t,r){c.on("ready",function(){return c._syncNodes.get({url:a},function(e){var n=c.syncable.connect(o,a,i);if(n.then(t,r),!e||!e.appliedRemoteRevision)return n})}),c.open().catch(function(e){r(new R.default.InvalidStateError("Dexie.Syncable: Couldn't connect. Database failed to open",e))})})}}(t,e);t.on("message",function(e){R.default.vip(function(){"connect"===e.type?t.syncable.connect(e.message.protocolName,e.message.url,e.message.options).then(e.resolve,e.reject):"disconnect"===e.type?t.syncable.disconnect(e.message.url).then(e.resolve,e.reject):"syncStatusChanged"===e.type&&t.syncable.on.statusChanged.fire(e.message.newStatus,e.message.url)})}),t.on("cleanup",function(e){e&&R.default.ignoreTransaction(function(){return R.default.vip(function(){return t._syncNodes.where({type:"remote"}).filter(function(e){return e.status!==w.OFFLINE}).toArray(function(e){return c.all(e.map(function(n){return t.syncable.connect(n.syncProtocol,n.url,n.syncOptions).catch(function(e){console.warn("Dexie.Syncable: Could not connect to ".concat(n.url,". ").concat(e.stack||e))})}))})})}).catch("DatabaseClosedError",function(){})}),t.on("ready",function(){t._localSyncNode&&t._localSyncNode.isMaster&&t._syncNodes.where("type").equals("remote").and(function(e){return e.status!==w.OFFLINE}).toArray(function(e){e.forEach(function(e){return t.syncable.connect(e.syncProtocol,e.url,e.syncOptions).catch(function(){})})}).catch("DatabaseClosedError",function(){})},!0),t.syncable={version:"4.0.0-beta.13"},t.syncable.getStatus=function(e,n){return t.isOpen()?R.default.vip(function(){return t._syncNodes.where("url").equals(e).first(function(e){return e?e.status:w.OFFLINE})}).then(n):c.resolve(f.Statuses.OFFLINE).then(n)},t.syncable.getOptions=function(e,n){return t.transaction("r?",t._syncNodes,function(){return t._syncNodes.where("url").equals(e).first(function(e){return e.syncOptions}).then(n)})},t.syncable.list=function(){return t.transaction("r?",t._syncNodes,function(){return t._syncNodes.where("type").equals("remote").toArray(function(e){return e.map(function(e){return e.url})})})},t.syncable.on=R.default.Events(t,{statusChanged:"asap"}),t.syncable.disconnect=function(n){return R.default.ignoreTransaction(function(){return c.resolve().then(function(){return t._localSyncNode&&t._localSyncNode.isMaster?c.all(r.filter(function(e){return e.url===n}).map(function(e){return e.disconnect(w.OFFLINE)})):t._syncNodes.where("isMaster").above(0).first(function(e){return t.observable.sendMessage("disconnect",{url:n},e.id,{wantReply:!0})})}).then(function(){return t._syncNodes.where("url").equals(n).modify(function(e){e.status=w.OFFLINE})})})},t.syncable.connect=function(e,n,t){t=t||{};var r=f.registeredProtocols[e];return r?o(r,e,n,t):c.reject(new Error("ISyncProtocol '"+e+"' is not registered in Dexie.Syncable.registerSyncProtocol()"))},t.syncable.delete=function(e){return t.syncable.disconnect(e).then(function(){return t.transaction("rw!",t._syncNodes,t._changes,t._uncommittedChanges,function(){var n;return t._syncNodes.where("url").equals(e).toArray(function(e){return e.map(function(e){return e.id})}).then(function(e){return n=e,t._syncNodes.where("id").anyOf(e).delete()}).then(function(){return t._uncommittedChanges.where("node").anyOf(n).delete()})}).then(function(){l.deleteOldChanges(t)})})},t.syncable.unsyncedChanges=function(e){return t._syncNodes.where("url").equals(e).first(function(e){return t._changes.where("rev").above(e.myRevision).toArray()})},t.close=i(t.close,function(e){return function(){return r.forEach(function(e){e.disconnect()}),e.apply(this,arguments)}}),Object.defineProperty(t.observable.SyncNode.prototype,"save",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;return t.transaction("rw?",t._syncNodes,function(){return t._syncNodes.put(e)})}})}}if(f.version="4.0.0-beta.13",f.Statuses=w,f.StatusTexts={"-1":"ERROR",0:"OFFLINE",1:"CONNECTING",2:"ONLINE",3:"SYNCING",4:"ERROR_WILL_RETRY"},f.registeredProtocols={},f.registerSyncProtocol=function(e,n){var t=n.partialsThreshold;if("number"==typeof t){if(isNaN(t)||t<0)throw new Error("The given number for the threshold is not supported")}else n.partialsThreshold=1/0;f.registeredProtocols[e]=n},R.default.Syncable){if("4.0.0-beta.13"!==R.default.Syncable.version)throw new Error("Mixed versions of dexie-syncable")}else R.default.Syncable=f,R.default.addons.push(f);return R.default.Syncable});